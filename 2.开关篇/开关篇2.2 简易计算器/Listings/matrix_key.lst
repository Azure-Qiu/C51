C51 COMPILER V9.60.7.0   MATRIX_KEY                                                        02/19/2024 10:54:07 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MATRIX_KEY
OBJECT MODULE PLACED IN .\Objects\matrix_key.obj
COMPILER INVOKED BY: C:\Software\Keil\C51\BIN\C51.EXE matrix_key.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\L
                    -istings\matrix_key.lst) OBJECT(.\Objects\matrix_key.obj)

line level    source

   1          #include "matrix_key.h"
   2          
   3          /** 
   4           **  @brief    å®ç°äº†çŸ©é˜µæŒ‰é”®çš„ä¸¤ç§æ‰«ææ–¹å¼
   5           **            1. å®ç°äº†å»¶æ—¶æ³•å’Œå®šæ—¶å™¨æ³•ä¸¤ç§åˆ·æ–°æ–¹å¼
   6           **  @author   QIU
   7           **  @date     2024.02.18
   8           **/
   9          
  10          
  11          /*-------------------------------------------------------------------*/
  12          
  13          // å­˜å‚¨æŒ‰ä¸‹çš„è¡Œåˆ—
  14          u8 row, col;
  15          // æŒ‰é”®äº‹ä»¶å¤„ç†çŠ¶æ€ï¼Œtrueå·²å¤„ç†ï¼Œfalseæœªå¤„ç†
  16          u8 key_is_dealed = false;
  17          
  18          // é”®å€¼å¯¹åº”æ˜¾ç¤ºæ•°å€¼
  19          u8 key_val = 0; 
  20          
  21          // åè½¬æ³•çŠ¶æ€æœº
  22          Turn_State turn_state = COL_Test;
  23          
  24          
  25          
  26          /**
  27           **  @brief   è¯»å–ç”µå¹³
  28           **  @param   state: 0-åˆ—ï¼Œ1-è¡Œ
  29           **  @retval  è¿”å›åˆ—ï¼ˆè¡Œï¼‰æ•°
  30           **/
  31          u8 read_port(bit state){
  32   1              u8 dat;
  33   1              if(state) dat = MATRIX_PORT >> 4; // å¦‚æœæ˜¯è¡Œï¼Œå–é«˜å››ä½
  34   1              else dat =  MATRIX_PORT & 0x0f;   // å¦‚æœæ˜¯åˆ—ï¼Œå–ä½å››ä½
  35   1              // ä»å·¦ä¸Šå¼€å§‹ä¸ºç¬¬ä¸€è¡Œï¼Œç¬¬ä¸€åˆ—
  36   1              switch(dat){
  37   2                      // 0000 1110 ç¬¬4åˆ—(è¡Œ)
  38   2                      case 0x0e: return 4;
  39   2                      // 0000 1101 ç¬¬3åˆ—(è¡Œ)
  40   2                      case 0x0d: return 3;
  41   2                      // 0000 1011 ç¬¬2åˆ—(è¡Œ)
  42   2                      case 0x0b: return 2;
  43   2                      // 0000 0111 ç¬¬1åˆ—(è¡Œ)
  44   2                      case 0x07: return 1;
  45   2                      // 0000 1111 æ²¡æœ‰æŒ‰ä¸‹
  46   2                      case 0x0f: return 0xff;
  47   2                      // å¤šé”®åŒæ—¶æŒ‰ä¸‹ä¸å“åº”
  48   2                      default: return 0;
  49   2              }
  50   1      }
  51          
  52          
  53          
  54          /**
C51 COMPILER V9.60.7.0   MATRIX_KEY                                                        02/19/2024 10:54:07 PAGE 2   

  55           **  @brief   çŸ©é˜µæŒ‰é”®å¤„ç†å‡½æ•°
  56           **  @param   å‚æ•°è¯´æ˜
  57           **  @retval  è¿”å›å€¼
  58           **/
  59          void key_pressed(){
  60   1              // å¦‚æœä¸æ˜¯è¿ç»­æ¨¡å¼ï¼Œåˆ™æŒ‰é”®äº‹ä»¶æ ‡è®°ä¸ºå·²å¤„ç†
  61   1              if(!MatrixKEY_MODE) key_is_dealed = true; 
  62   1              // è®¡ç®—å™¨å¤„ç†å‡½æ•°
  63   1              calculator_deal_key(row, col);
  64   1      }
  65          
  66          
  67          
  68          /**
  69           **  @brief   (åè½¬æ³•)æ£€æµ‹æŒ‰é”®ï¼ˆå•é”®ï¼‰ï¼ŒæŒ‰ä½è¿‡ç¨‹ä¸­å±è”½å…¶ä»–æŒ‰é”®ã€‚åŒåˆ—éœ€å…¨éƒ¨æ¾
             -å¼€æ‰èƒ½å†æ¬¡å“åº”
  70           **  @param   æ— 
  71           **  @retval  æ— 
  72           **/
  73          void check_matrixKey_turn(){
  74   1              // æ‰€æœ‰è¡Œç½®ä½ç”µå¹³ï¼Œåˆ—ç½®é«˜ç”µå¹³
  75   1              MATRIX_PORT = 0x0f;
  76   1              // è¯»å–æ‰€æœ‰åˆ—ç”µå¹³
  77   1              col = read_port(0);
  78   1              // å¦‚æœæŒ‰é”®æ¾å¼€
  79   1              if(col == 0xff) {key_is_dealed = false; return;}
  80   1              // å¦‚æœæœ‰æ•ˆé”®æŒ‰ä¸‹ï¼Œå»¶æ—¶æ¶ˆæŠ–
  81   1              else if(col && !key_is_dealed) delay_ms(10);
  82   1              else return; 
  83   1              // æ‰€æœ‰åˆ—ç½®ä½ç”µå¹³ï¼Œè¡Œç½®é«˜ç”µå¹³
  84   1              MATRIX_PORT = 0xf0;
  85   1              // è¯»å–æ‰€æœ‰è¡Œç”µå¹³
  86   1              row = read_port(1);
  87   1              // å¦‚æœæœ‰é”®æŒ‰ä¸‹ï¼Œå“åº”
  88   1              if(row && row != 0xff) key_pressed();
  89   1              else return;
  90   1      }
  91          
  92          
  93          /**
  94           **  @brief   (æ‰«ææ³•)æ£€æµ‹æŒ‰é”®ï¼Œæœ¬ä¾‹æ‰«æåˆ—
  95           **  @param   æ— 
  96           **  @retval  æ— 
  97           **/
  98          void check_matrixKey_scan(){
  99   1              u8 i;
 100   1              for(i=0;i<4;i++){
 101   2                      MATRIX_PORT = ~(0x08>>i); // é€åˆ—ç½®0ï¼Œä¸”æ‰€æœ‰è¡Œç½®1
 102   2                      row = read_port(1); // è¯»å–è¡Œ
 103   2                      // ä¿è¯ä¹‹å‰è®°å½•æŒ‰ä¸‹çš„åˆ—ä¸ºå½“å‰æ‰«æåˆ—
 104   2                      if(!row && col == i+1) continue; // å½“å‰æ‰«æåˆ—æ— æœ‰æ•ˆé”®æŒ‰ä¸‹
 105   2                      else if(row == 0xff && col == i+1) {key_is_dealed = false; continue;}
 106   2                      else if(row && !key_is_dealed){       // æœ‰æ•ˆé”®æŒ‰ä¸‹ä¸”ä¸ºæœªå¤„ç†çŠ¶æ€
 107   3                              delay_ms(10);
 108   3                              row = read_port(1); // å†æ¬¡è¯»å–è¡Œ
 109   3                              if(row && row != 0xff) {col = i+1;key_pressed();} 
 110   3                      }
 111   2              }
 112   1      }
 113          
 114          
 115          /**
C51 COMPILER V9.60.7.0   MATRIX_KEY                                                        02/19/2024 10:54:07 PAGE 3   

 116           **  @brief   (åè½¬æ³•)é‡‡ç”¨å®šæ—¶å™¨
 117           **  @param   å‚æ•°è¯´æ˜
 118           **  @retval  è¿”å›å€¼
 119           **/
 120          void check_matrixKey_turn_ByTimer(){
 121   1              static u8 counter = 0;
 122   1              switch(turn_state){
 123   2                      case COL_Test:
 124   2                              // æ‰€æœ‰è¡Œç½®ä½ç”µå¹³ï¼Œåˆ—ç½®é«˜ç”µå¹³
 125   2                              MATRIX_PORT = 0x0f;
 126   2                              // è¯»å–æ‰€æœ‰åˆ—ç”µå¹³
 127   2                              col = read_port(0);
 128   2                              // å¦‚æœæŒ‰é”®æœªæŒ‰ä¸‹ï¼ˆå·²æ¾å¼€ï¼‰
 129   2                              if(col == 0xff) {key_is_dealed = false; break;}
 130   2                              // å¦‚æœæœ‰æ•ˆé”®æŒ‰ä¸‹ï¼Œä¸”æŒ‰é”®æœªå¤„ç†æ—¶ï¼ŒçŠ¶æ€æµè½¬
 131   2                              else if(col && !key_is_dealed) turn_state = Filter;
 132   2                              break;
 133   2                      case Filter:
 134   2                              counter++;
 135   2                              // ä¸€èˆ¬å®šæ—¶1msï¼Œå³è¿‡æ»¤10msé˜²æŠ–
 136   2                              if(counter >= 10){
 137   3                                      counter = 0; 
 138   3                                      turn_state = ROW_Test;
 139   3                              }
 140   2                              break;
 141   2                      case ROW_Test:
 142   2                              // æ‰€æœ‰åˆ—ç½®ä½ç”µå¹³ï¼Œè¡Œç½®é«˜ç”µå¹³
 143   2                              MATRIX_PORT = 0xf0;
 144   2                              // è¯»å–æ‰€æœ‰è¡Œç”µå¹³
 145   2                              row = read_port(1);
 146   2                              // å¦‚æœæœ‰é”®æŒ‰ä¸‹ï¼Œå“åº”
 147   2                              if(row && row != 0Xff) key_pressed();
 148   2                              // çŠ¶æ€æµè½¬
 149   2                              turn_state = COL_Test;
 150   2                              break;
 151   2              }
 152   1      }
 153          
 154          
 155          
 156          /**
 157           **  @brief   (æ‰«ææ³•)é‡‡ç”¨å®šæ—¶å™¨
 158           **  @param   æ— 
 159           **  @retval  æ— 
 160           **/
 161          void check_matrixKey_scan_ByTimer(){
 162   1              static u8 i, counter;
 163   1      
 164   1              // å¼€å§‹æ»¤æŠ–
 165   1              if(counter){
 166   2                      if(counter > 10){
 167   3                              counter = 0;
 168   3                              row = read_port(1); // å†æ¬¡è¯»å–è¡Œ
 169   3                              if(row && row != 0xff) {col = i+1; key_pressed();}
 170   3                      }else{
 171   3                              counter++;
 172   3                      }
 173   2              }else{
 174   2                      MATRIX_PORT = ~(0x08>>i); // é€åˆ—ç½®0ï¼Œä¸”æ‰€æœ‰è¡Œç½®1
 175   2                      row = read_port(1); // è¯»å–è¡Œ
 176   2                      // ä¿è¯ä¹‹å‰è®°å½•æŒ‰ä¸‹çš„åˆ—ä¸ºå½“å‰æ‰«æåˆ—
 177   2                      if(row == 0xff && col == i+1) {key_is_dealed = false;}
C51 COMPILER V9.60.7.0   MATRIX_KEY                                                        02/19/2024 10:54:07 PAGE 4   

 178   2                      else if(row && row != 0xff && !key_is_dealed) {counter++; return;} // æœ‰æ•ˆé”®æŒ‰ä¸‹ä¸”ä¸ºæœªå¤„ç†çŠ¶æ
             -€
 179   2                      
 180   2                      i++;
 181   2                      if(i >= 4) i = 0;
 182   2              }
 183   1      }
 184          
 185          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    431    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
