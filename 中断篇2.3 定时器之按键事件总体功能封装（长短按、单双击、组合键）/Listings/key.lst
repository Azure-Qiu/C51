C51 COMPILER V9.60.7.0   KEY                                                               02/08/2024 14:03:40 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\Objects\key.obj
COMPILER INVOKED BY: C:\Software\Keil\C51\BIN\C51.EXE key.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings
                    -\key.lst) OBJECT(.\Objects\key.obj)

line level    source

   1          #include "key.h"
   2          // åŒ…å«çš„å¤´æ–‡ä»¶ï¼ˆæŒ‰éœ€æ±‚ä¿®æ”¹ï¼‰
   3          #include "led.h"
   4          #include "smg.h"
   5          
   6          
   7          /** 
   8           **  @brief    ç‹¬ç«‹æŒ‰é”®çš„å‡½æ•°å°è£…
   9           **            1. å•é”®çš„çŸ­æŒ‰ä¸é•¿æŒ‰äº‹ä»¶ï¼ˆé•¿æŒ‰äº‹ä»¶åˆ†å•æ¬¡æˆ–è¿ç»­å“åº”ï¼‰
  10           **            2. å•é”®çš„å•å‡»ä¸åŒå‡»äº‹ä»¶
  11           **            3. ç»„åˆé”®çš„çŸ­æŒ‰ä¸é•¿æŒ‰äº‹ä»¶
  12           **  @author   QIU
  13           **  @date     2024.02.07
  14           **/
  15          
  16          /*-------------------------------------------------------------------*/
  17          
  18          // å®æ—¶æŒ‰é”®çŠ¶æ€ã€å½“å‰ç¡®è®¤çŠ¶æ€ã€å‰ç¡®è®¤çŠ¶æ€
  19          Key_State key_state, key_now_state, key_pre_state;
  20          // å½“å‰æŒ‰é”®æ¨¡å¼
  21          Key_Mode key_mode = FREE_MODE;
  22          // åŒå‡»æ ‡å¿—
  23          u8 Double_Click_flag = false;
  24          // åŒå‡»æœ€å¤§å»¶æ—¶è®¡æ•°å™¨
  25          u16 Double_Click_Counter = 0;
  26          
  27          // æŒ‰é”®ç´¯ç§¯
  28          u16 num = 0;
  29          // LEDæµæ°´ç¯é€Ÿåº¦
  30          u16 led_speed = 10000;
  31          
  32          
  33          /*------------------------æŒ‰é”®å“åº”å‡½æ•°å®šä¹‰åŒº------------------------------*/
  34          
  35          
  36          /**
  37           **  @brief   æŒ‰é”®3çŸ­æŒ‰ï¼ŒçŸ­æŒ‰å“åº”ï¼Œåœ¨æŒ‰é”®æ¾å¼€ååˆ¤å®šæ‰§è¡Œ
  38           **  @param   å‚æ•°è¯´æ˜
  39           **  @retval  è¿”å›å€¼
  40           **/
  41          void key3_short_press(){
  42   1              led_turn(1);
  43   1      }
  44          
  45          
  46          /**
  47           **  @brief   æŒ‰é”®3é•¿æŒ‰ï¼ŒæŒ‰ä¸‹å“åº”
  48           **  @param   å‚æ•°è¯´æ˜
  49           **  @retval  è¿”å›å€¼
  50           **/
  51          void key3_long_press(){
  52   1              led_run(led_speed);
  53   1      }
  54          
C51 COMPILER V9.60.7.0   KEY                                                               02/08/2024 14:03:40 PAGE 2   

  55          
  56          
  57          /**
  58           **  @brief   æŒ‰é”®3åŒå‡»
  59           **  @param   å‚æ•°è¯´æ˜
  60           **  @retval  è¿”å›å€¼
  61           **/
  62          void key3_double_click(){
  63   1              led_turn(2);
  64   1      }
  65          
  66          
  67          /**
  68           **  @brief   æŒ‰é”®4çŸ­æŒ‰ï¼ŒçŸ­æŒ‰å“åº”ï¼Œåœ¨æŒ‰é”®æ¾å¼€ååˆ¤å®šæ‰§è¡Œ
  69           **  @param   å‚æ•°è¯´æ˜
  70           **  @retval  è¿”å›å€¼
  71           **/
  72          void key4_short_press(){
  73   1              led_turn(3);
  74   1      }
  75          
  76          
  77          /**
  78           **  @brief   æŒ‰é”®4é•¿æŒ‰ï¼ŒæŒ‰ä¸‹å“åº”
  79           **  @param   å‚æ•°è¯´æ˜
  80           **  @retval  è¿”å›å€¼
  81           **/
  82          void key4_long_press(){
  83   1              led_stream(led_speed);
  84   1      }
  85          
  86          
  87          
  88          /**
  89           **  @brief   æŒ‰é”®å››åŒå‡»
  90           **  @param   å‚æ•°è¯´æ˜
  91           **  @retval  è¿”å›å€¼
  92           **/
  93          void key4_double_click(){
  94   1              led_turn(4);
  95   1      }
  96          
  97          
  98          /**
  99           **  @brief   æŒ‰é”®3ã€4ç»„åˆé”®ï¼ŒçŸ­æŒ‰å“åº”
 100           **  @param   å‚æ•°è¯´æ˜
 101           **  @retval  è¿”å›å€¼
 102           **/
 103          void key3_4_combination(){
 104   1              led_turn(5);
 105   1      }
 106          
 107          
 108          /**
 109           **  @brief   æŒ‰é”®3ã€4ç»„åˆé”®ï¼Œé•¿æŒ‰å“åº”
 110           **  @param   å‚æ•°è¯´æ˜
 111           **  @retval  è¿”å›å€¼
 112           **/
 113          void key3_4_long_combination(){
 114   1              num++;
 115   1              smg_showInt(num, 1);
 116   1      }
C51 COMPILER V9.60.7.0   KEY                                                               02/08/2024 14:03:40 PAGE 3   

 117          
 118          
 119          
 120          /*--------------------------å»¶æ—¶æ³•æŒ‰é”®æ£€æµ‹-------------------------------*/
 121          
 122          
 123          
 124          #if 0
              
              /**
               **  @brief   æŒ‰é”®æ¾å¼€å“åº”
               **  @param   æ— 
               **  @retval  æ— 
               **/
              void key_unpress(){
                      switch(key_pre_state){
                              case KEY_UNPRESS: break;
                              case KEY1_PRESS: key1_unpressed();break;
                              case KEY2_PRESS: key2_unpressed();break;
                              case KEY3_PRESS: key3_unpressed();break;
                              case KEY4_PRESS: key4_unpressed();break;
                              case KEY1_2_PRESS: key1_2_unpressed();break;
                              case KEY2_3_PRESS: key2_3_unpressed();break;
                              case KEY3_4_PRESS: key3_4_unpressed();break;
                      }
              }
              
              
              /**
               **  @brief   ï¼ˆè½®è¯¢æ–¹å¼ï¼‰æ‰«æç‹¬ç«‹æŒ‰é”®ï¼Œåˆ¤æ–­å“ªä¸ªé”®æŒ‰ä¸‹
               **  @param   æ— 
               **  @retval  æ— 
               **/
              void scan_key(){
                      static u8 flag = 1;
              
                      // å¦‚æœæœ‰æŒ‰é”®æŒ‰ä¸‹
                      if(flag && (!key1||!key2||!key3||!key4)){
                              flag = 0; // æ¸…é›¶
                              delay_ms(10); // å»¶æ—¶10msæ¶ˆæŠ–
                              delay_ms(50); // å»¶æ—¶50ms å®¹è®¸é—´éš”
                              // è·å–å½“å‰æ‰€æœ‰æŒ‰ä¸‹çš„é”®
                              if(!key1) key_now_state |= KEY1_PRESS; 
                              if(!key2) key_now_state |= KEY2_PRESS; 
                              if(!key3) key_now_state |= KEY3_PRESS; 
                              if(!key4) key_now_state |= KEY4_PRESS; 
              
                      // å¦‚æœæŒ‰é”®å…¨éƒ¨æ¾å¼€
                      }else if(key1&&key2&&key3&&key4){
                              flag = 1;
                              delay_ms(10); // å»¶æ—¶10msæ¶ˆæŠ–,æ¾å¼€å“åº”æœ‰é€»è¾‘åˆ¤æ–­æ—¶ï¼Œéœ€è¦åŠ ä¸Šæ¶ˆæŠ–ã€‚å¦åˆ™å¯ä»¥çœç
             -•¥ã€‚
                              if(key1&&key2&&key3&&key4)key_now_state = 0;
                      }
              }
              
              
              
              /**
               **  @brief   ï¼ˆè½®è¯¢æ–¹å¼ï¼‰åˆ¤æ–­æŒ‰é”®, è¿›è¡Œç›¸åº”å¤„ç†
               **  @param    æ— 
               **  @retval   æ— 
C51 COMPILER V9.60.7.0   KEY                                                               02/08/2024 14:03:40 PAGE 4   

               **/
              void check_key(){
                      switch(key_now_state){
                              case KEY_UNPRESS:
                                      // æ¾å¼€å“åº”
                                      key_unpress();
                                      key_pre_state = KEY_UNPRESS;
                                      break;
                              case KEY1_PRESS:
                                      key_pre_state = KEY1_PRESS;
                                      // å¦‚æœæ˜¯å•æ¬¡å“åº”
                                      if(!KEY1_MODE) key_now_state = KEY_NON_DEAL;
                                      key1_pressed();
                                      break;
                              case KEY2_PRESS:
                                      key_pre_state = KEY2_PRESS;
                                      if(!KEY2_MODE) key_now_state = KEY_NON_DEAL;
                                      break;
                              case KEY3_PRESS:
                                      key_pre_state = KEY3_PRESS;
                                      if(!KEY3_MODE) key_now_state = KEY_NON_DEAL;
                                      key3_pressed();
                                      break;
                              case KEY4_PRESS:
                                      key_pre_state = KEY4_PRESS;
                                      if(!KEY4_MODE) key_now_state = KEY_NON_DEAL;
                                      key4_pressed();
                                      break;
                              case KEY1_2_PRESS:
                                      key_pre_state = KEY1_2_PRESS;
                                      if(!KEY_1_2_MODE) key_now_state = KEY_NON_DEAL;
                                      key_1_2_pressed();
                                      break;
                              case KEY2_3_PRESS:
                                      key_pre_state = KEY2_3_PRESS;
                                      if(!KEY_2_3_MODE) key_now_state = KEY_NON_DEAL;
                                      key_2_3_pressed();
                                      break;
                              case KEY3_4_PRESS:
                                      key_pre_state = KEY3_4_PRESS;
                                      if(!KEY_3_4_MODE) key_now_state = KEY_NON_DEAL;
                                      key_3_4_pressed();
                                      break;
                              case KEY_NON_DEAL:
                                      // æŒ‰ä¸‹ä¸å¤„ç†
                                      break;
                      }
              }
              
              #endif
 228          
 229          /*---------------------------å®šæ—¶å™¨æ³•æŒ‰é”®æ£€æµ‹--------------------------------*/
 230          
 231          
 232          /**
 233           **  @brief   åŒå‡»äº‹ä»¶æ£€æµ‹
 234           **  @param   å‚æ•°è¯´æ˜
 235           **  @retval  è¿”å›å€¼
 236           **/
 237          void scan_double_click(){
 238   1              if(Double_Click_flag){
 239   2                      Double_Click_Counter++;
C51 COMPILER V9.60.7.0   KEY                                                               02/08/2024 14:03:40 PAGE 5   

 240   2                      // å¦‚æœå·²ç»è¶…è¿‡äº†åŒå‡»æ—¶é—´ç•Œçº¿
 241   2                      if(Double_Click_Counter >= KEY_DOUBLE_DURATION){
 242   3                              // ä¸Šæ¬¡çŸ­æŒ‰è§†ä¸ºå•å‡»äº‹ä»¶
 243   3                              key_mode = SHORT_PRESS;
 244   3                              Double_Click_Counter = 0;
 245   3                              Double_Click_flag = false;
 246   3                      }
 247   2              }else{
 248   2                      Double_Click_Counter = 0;
 249   2              }
 250   1      }
 251          
 252          
 253          
 254          
 255          /**
 256           **  @brief   ï¼ˆè½®è¯¢æ–¹å¼ï¼‰åˆ¤æ–­æŒ‰é”®çŠ¶æ€ä¸æ¨¡å¼, è¿›è¡Œç›¸åº”å¤„ç†
 257           **  @param    æ— 
 258           **  @retval   æ— 
 259           **/
 260          void check_key(){
 261   1              
 262   1              // æ£€æŸ¥æŒ‰é”®æ¨¡å¼
 263   1              switch(key_mode){
 264   2                      case SHORT_PRESS:
 265   2                              // æŒ‰é”®æ¨¡å¼æµè½¬
 266   2                              key_mode = FREE_MODE;
 267   2                              // çŸ­æŒ‰åªæœ‰æ¾å¼€å“åº”ï¼Œæ•…è€ƒè™‘å‰çŠ¶æ€
 268   2                              // çŸ­æŒ‰å‡ä¸ºå•æ¬¡å“åº”
 269   2                              switch(key_pre_state){
 270   3                                      case KEY1_PRESS:break;
 271   3                                      case KEY2_PRESS:break;
 272   3                                      case KEY3_PRESS:key3_short_press();break;
 273   3                                      case KEY4_PRESS:key4_short_press();break;
 274   3                                      case KEY1_2_PRESS:break;
 275   3                                      case KEY1_3_PRESS:break;
 276   3                                      case KEY1_4_PRESS:break;
 277   3                                      case KEY2_3_PRESS:break;
 278   3                                      case KEY2_4_PRESS:break;
 279   3                                      case KEY3_4_PRESS:key3_4_combination();break;
 280   3                              }
 281   2                              break;
 282   2                      case LONG_PRESS:
 283   2                              // é•¿æŒ‰åªæœ‰æŒ‰ä¸‹å“åº”ï¼Œæ•…è€ƒè™‘å½“å‰çŠ¶æ€
 284   2                              // é•¿æŒ‰åˆ†ä¸ºå•æ¬¡å“åº”å’Œè¿ç»­å“åº”
 285   2                              switch(key_now_state){
 286   3                                      case KEY1_PRESS:break;
 287   3                                      case KEY2_PRESS:break;
 288   3                                      case KEY3_PRESS:
 289   3                                              if(!KEY3_MODE) key_mode = FREE_MODE;
 290   3                                              key3_long_press();
 291   3                                              break;
 292   3                                      case KEY4_PRESS:
 293   3                                              if(!KEY4_MODE) key_mode = FREE_MODE;
 294   3                                              key4_long_press();
 295   3                                              break;
 296   3                                      case KEY1_2_PRESS:break;
 297   3                                      case KEY1_3_PRESS:break;
 298   3                                      case KEY1_4_PRESS:break;
 299   3                                      case KEY2_3_PRESS:break;
 300   3                                      case KEY2_4_PRESS:break;
 301   3                                      case KEY3_4_PRESS:
C51 COMPILER V9.60.7.0   KEY                                                               02/08/2024 14:03:40 PAGE 6   

 302   3                                              // æŒ‰é”®æ¨¡å¼æµè½¬
 303   3                                              if(!KEY_3_4_MODE) key_mode = FREE_MODE;
 304   3                                              key3_4_long_combination();
 305   3                                              break;
 306   3                              }
 307   2                              break;
 308   2                      case DOUBLE_CLICK:
 309   2                              key_mode = FREE_MODE;
 310   2                              // åŒå‡»åªæœ‰æŒ‰ä¸‹å“åº”ï¼Œæ•…è€ƒè™‘å½“å‰çŠ¶æ€
 311   2                              // åŒå‡»åªæœ‰å•æ¬¡å“åº”
 312   2                              switch(key_now_state){
 313   3                                      case KEY1_PRESS:break;
 314   3                                      case KEY2_PRESS:break;
 315   3                                      case KEY3_PRESS:key3_double_click();break;
 316   3                                      case KEY4_PRESS:key4_double_click();break;
 317   3                                      case KEY1_2_PRESS:break;
 318   3                                      case KEY1_3_PRESS:break;
 319   3                                      case KEY1_4_PRESS:break;
 320   3                                      case KEY2_3_PRESS:break;
 321   3                                      case KEY2_4_PRESS:break;
 322   3                                      case KEY3_4_PRESS:break;
 323   3                              }
 324   2                              break;
 325   2                      default:
 326   2                              break;
 327   2              }
 328   1              
 329   1      }
 330          
 331          
 332          
 333          
 334          /**
 335           **  @brief   ï¼ˆå®šæ—¶å™¨ï¼‰ç¡®è®¤æŒ‰é”®æ˜¯å¦ç¨³å®šæŒ‰ä¸‹/æ¾å¼€ï¼Œå»æŠ–
 336           **  @param   æ— 
 337           **  @retval  æ— 
 338           **/
 339          void scan_key_ByTimer(){
 340   1              static u16 counter = 0; 
 341   1              static u8 flag = 0xff;
 342   1              
 343   1              // é•¿æŒ‰äº‹ä»¶å¼€å…³
 344   1              static bit flag_LongMode = true;
 345   1              // åŒå‡»äº‹ä»¶å¼€å…³
 346   1              static bit flag_DoubleClickMode = false;
 347   1              // ç»„åˆäº‹ä»¶å¼€å…³
 348   1              static bit flag_CombinationMode = false;
 349   1      
 350   1              
 351   1              flag <<= 1;
 352   1      
 353   1              if(key_state & KEY3_PRESS) flag |= key3; // å¦‚æœå®æ—¶æŒ‰é”®çŠ¶æ€ä¸­åŒ…å«é”®3ï¼Œåˆ™æ£€æŸ¥é”®3å¼•è„šçŠ
             -¶æ€ï¼ˆæŒ‰ä¸‹ä¸º0ï¼‰
 354   1              if(key_state & KEY4_PRESS) flag |= key4; // å¦‚æœå®æ—¶æŒ‰é”®çŠ¶æ€ä¸­åŒ…å«é”®4ï¼Œåˆ™æ£€æŸ¥é”®4å¼•è„šçŠ
             -¶æ€ï¼ˆæŒ‰ä¸‹ä¸º0ï¼‰
 355   1              
 356   1              switch(flag){
 357   2                      case 0xff:
 358   2                              // è¿ç»­8æ¬¡æ£€æµ‹åˆ°æŒ‰é”®æ¾å¼€ï¼Œè§†ä¸ºæ¾å¼€çŠ¶æ€ã€‚
 359   2                              key_state &= ((~key3*KEY3_PRESS) | (~key4*KEY4_PRESS));
 360   2                              // æŒ‰é”®çŠ¶æ€æ›´æ–°
 361   2                              key_pre_state = key_now_state;
C51 COMPILER V9.60.7.0   KEY                                                               02/08/2024 14:03:40 PAGE 7   

 362   2                              key_now_state = key_state;
 363   2                      
 364   2                              if(flag_DoubleClickMode){
 365   3                                      flag_DoubleClickMode = false;
 366   3                              }else{
 367   3                                      if(flag_CombinationMode){
 368   4                                              // è§£é™¤å±è”½
 369   4                                              flag_CombinationMode = false;
 370   4                                      }else{
 371   4                                              // å¦‚æœå°äºé˜ˆå€¼ï¼Œåˆ™ä¸ºçŸ­æŒ‰æ“ä½œ
 372   4                                              if(counter < KEY_DOWN_DURATION){
 373   5                                                      // ç­‰å¾…ç»™å®šåŒå‡»é˜ˆå€¼ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºåŒå‡»äº‹ä»¶
 374   5                                                      Double_Click_flag = true;
 375   5                                                      // æ¸…é›¶
 376   5                                                      counter = 0;
 377   5                                              }else{
 378   5                                                      // é•¿æŒ‰åªæœ‰æŒ‰ä¸‹å“åº”
 379   5                                                      key_mode = FREE_MODE;
 380   5                                                      // æ¸…é›¶
 381   5                                                      counter = 0;
 382   5                                                      flag_LongMode = true;
 383   5                                              }
 384   4                                      }
 385   3                              }
 386   2                              // å¦‚æœé”®å°šæœªå®Œå…¨æ¾å¼€ï¼Œåˆ™å‰©ä½™é”®è¢«å±è”½
 387   2                              if(key_now_state != KEY_UNPRESS) flag_CombinationMode = true;
 388   2                              break;
 389   2                      
 390   2                      case 0x00:
 391   2                              // å¦‚æœæŒ‰é”®çŠ¶æ€æœªå˜åŒ–
 392   2                              if(key_state == key_now_state){
 393   3                                      if(flag_DoubleClickMode){
 394   4                                              // å¦‚æœæ˜¯åŒå‡»äº‹ä»¶ï¼Œåˆ™ä¸å†å…³å¿ƒç¬¬äºŒæ¬¡å•å‡»æ‰€è€—æ—¶é•¿
 395   4                                              // æŒ‰ä½æœŸé—´ä¼šå±è”½å…¶ä»–æŒ‰é”®
 396   4                                      }else if(flag_CombinationMode){
 397   4                                              // å¦‚æœå¤„äºç»„åˆæŒ‰é”®å±è”½çš„çŠ¶æ€ï¼Œä¸åšå“åº”
 398   4                                      }else{
 399   4                                              if(counter >= KEY_DOWN_DURATION){
 400   5                                                      if(flag_LongMode){
 401   6                                                              // è§†ä¸ºè¯¥é”®çš„é•¿æŒ‰æ¨¡å¼
 402   6                                                              flag_LongMode = false;
 403   6                                                              key_mode = LONG_PRESS;
 404   6                                                      }
 405   5                                              }else{
 406   5                                                      counter++; // å¼€å§‹è®¡æ—¶
 407   5                                              }
 408   4                                      }
 409   3                              }else{
 410   3                                      // è¿ç»­8æ¬¡æ£€æµ‹åˆ°æŒ‰é”®æŒ‰ä¸‹ï¼Œè§†ä¸ºæŒ‰ä¸‹çŠ¶æ€ã€‚
 411   3                                      // å¦‚æœæŒ‰é”®åŠ¨ä½œç›¸åŒä¸”Double_Click_flagä¸ºçœŸï¼ˆå³æœªè¶…æ—¶ï¼‰ï¼Œå¯è§†ä¸ºåŒå‡»äº‹ä»¶
 412   3                                      if((key_state == key_pre_state) && Double_Click_flag){
 413   4                                              key_mode = DOUBLE_CLICK;
 414   4                                              flag_DoubleClickMode = true;
 415   4                                              Double_Click_flag = false;
 416   4                                      }else{
 417   4                                              // é‡æ–°è®¡æ—¶ï¼ˆå¼€å§‹è®°å½•ç»„åˆé”®æ—¶é•¿ï¼‰
 418   4                                              counter = 0;
 419   4                                      }
 420   3                                      // æ›´æ–°æŒ‰é”®çŠ¶æ€
 421   3                                      key_pre_state = key_now_state;
 422   3                                      key_now_state = key_state;
 423   3                              }       
C51 COMPILER V9.60.7.0   KEY                                                               02/08/2024 14:03:40 PAGE 8   

 424   2                              break;
 425   2              }
 426   1      }
 427          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    371    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     14    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
